wot={},wot.parser=function(){},wot.parser.prototype={DB_COUNT_OFFSET:4,DB_DATA_OFFSET:8,BF_BLOCKSIZE:8,BF_KEY:"DE72BEA0DE04BEB1DEFEBEEFDEADBEEF",parse:function(t){var e=new DataView(t),i=new wot.replay;return i.setBlocks(this.readBlocks(e)),i.begin=JSON.parse(this.ab2str(i.begin)),i.end&&(i.end=JSON.parse(this.ab2str(i.end))),MAIN_REPLAY=i,i.raw_zip=this.decrypt(i.raw),i.raw_dec=this.decompress(i.raw_zip),i.raw=i.raw_dec,i.setPackets(this.readPackets(i.raw)),i},ab2str:function(t,e){if("undefined"==typeof e)return String.fromCharCode.apply(null,new Uint8Array(t));for(var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.length;e>n;n++)i+=String.fromCharCode(0);return i},str2ab:function(t){var e=new ArrayBuffer(t.length),i=new Uint8Array(e),n=0;for(n=0;n<t.length;n+=1){if(t.charCodeAt(n)>255)throw new Error(n+" too big: "+t.charCodeAt(n)+"( "+t.length+")");i[n]=t.charCodeAt(n)}return e},readPackets:function(t){for(var e=new wot.replay.packet.reader(t),i=[];e.hasNext();)i.push(e.next());return i},decrypt:function(t){for(var e=[],i=0;i<this.BF_KEY.length;i+=2)e.push(parseInt(this.BF_KEY.substr(i,2),16));for(var n=new jsbfsh.context(e),s=this.BF_BLOCKSIZE-t.byteLength%this.BF_BLOCKSIZE,a=new Uint8Array(this.BF_BLOCKSIZE),r=new ArrayBuffer(t.byteLength+s),o=new Uint8Array(r),i=0;i<this.BF_BLOCKSIZE;i++)a[i]=0;for(var i=0;i<t.byteLength;i+=this.BF_BLOCKSIZE){var h=new Uint8Array(t.slice(i,i+this.BF_BLOCKSIZE));if(h.length<this.BF_BLOCKSIZE){for(var l=new Uint8Array(this.BF_BLOCKSIZE),c=0;c<this.BF_BLOCKSIZE;c++)l[c]=h[c];h=l}jsbfsh.decrypt(n,h,[0,0,0,0,0,0,0,0]);for(var p=0;p<this.BF_BLOCKSIZE;p++)h[p]=a[p]^h[p],a[p]=h[p],o[i+p]=h[p]}return r.slice(0,t.byteLength)},decompress:function(t){for(var e=pako.inflate(new Uint8Array(t)),i=new ArrayBuffer(e.length),n=new Uint8Array(i),s=0;s<e.length;s++)n[s]=e[s];return i},readBlocks:function(t){for(var e=[],i=t.getUint32(this.DB_COUNT_OFFSET,!0),n=this.DB_DATA_OFFSET,s=0;i>s;s++){var a=t.getUint32(n,!0),r=n+4;e.push(t.buffer.slice(r,r+a)),n=r+a}return e.push(t.buffer.slice(n+8)),e}},wot.player=function(){this.construct.apply(this,arguments)},wot.player.prototype={replay:null,clock:0,lastClock:0,state:"stopped",onPacket:null,onPlayerPosition:null,onPlayerRotation:null,onPlayerHealth:null,onPlayerTurretRotation:null,onPlayerSpotted:null,onPlayerUnspotted:null,onPlayerDamaged:null,construct:function(t){this.onPacket=new wot.player.event,this.onPlayerPosition=new wot.player.event,this.onPlayerRotation=new wot.player.event,this.onPlayerHealth=new wot.player.event,this.onPlayerTurretRotation=new wot.player.event,this.onPlayerTurretYaw=new wot.player.event,this.onPlayerSpotted=new wot.player.event,this.onPlayerUnspotted=new wot.player.event,this.onPlayerDamaged=new wot.player.event,this.setReplay(t)},setReplay:function(t){this.replay=t},seek:function(t){for(this.clock=0;this.clock<t;)this.tick(1)},tick:function(t){for(var e=this.replay.getPackets(Math.floor(this.clock)),i=0,n=e.length;n>i;i++){var s=e[i];if(!(s.clock<this.lastClock||s.clock>this.clock))switch(this.onPacket.fire(this,s),s.type){case 5:this.onPlayerSpotted.fire(this,s.playerId),this.onPlayerHealth.fire(this,s.health);break;case 7:switch(s.subType){case 2:this.onPlayerTurretRotation.fire(this,s.playerId,s.turretRotation);break;case 3:this.onPlayerHealth.fire(this,s.playerId,s.health);break;case 4:this.onPlayerTurretYaw.fire(this,s.playerId,s.gunRotation)}break;case 8:switch(s.subType){case 1:this.onPlayerDamaged.fire(this,s.playerId,s.source,s.health),this.onPlayerHealth.fire(this,s.playerId,s.health)}break;case 10:this.onPlayerPosition.fire(this,s.playerId,s.position),this.onPlayerRotation.fire(this,s.playerId,s.hullRotation);break;case 25:}}this.lastClock=this.clock,this.clock+=t}},wot.player.event=function(){this.construct.apply(this,arguments)},wot.player.event.prototype={listeners:null,construct:function(){this.listeners=[]},attach:function(t){this.listeners.push(t)},remove:function(t){var e=this.listeners.indexOf(t);-1!=e&&this.listeners.splice(e,1)},fire:function(t){var e=[];Array.prototype.push.apply(e,arguments),e.shift();for(var i=0;i<this.listeners.length;i++)this.listeners[i].apply(t,e)}},wot.replay=function(){this.construct.apply(this,arguments)},wot.replay.prototype={frames:null,maxClock:null,battleStart:null,mainPlayerName:null,mainPlayerId:null,raw:null,begin:null,end:null,packets:null,blocks:null,construct:function(){},setBlocks:function(t){this.blocks=t,this.begin=this.blocks[0],this.blocks.length>2&&(this.end=this.blocks[1]),this.raw=this.blocks[this.blocks.length-1]},setPackets:function(t){this.packets=t,this.frames={};for(var e=0,i=this.packets.length;i>e;e++){var n=this.packets[e],s=Math.floor(n.clock);this.frames[s]||(this.frames[s]=[]),this.frames[s].push(n),n.clock>this.maxClock&&(this.maxClock=n.clock),18==n.type&&(this.battleStart=n.clock),0==n.type&&(this.mainPlayerName=n.playerName),30==n.type&&(this.mainPlayerId=n.playerId)}},getMainPlayerId:function(){if(null==this.mainPlayerId)for(var t in this.begin.vehicles)if(this.begin.vehicles[t].name==this.main)return t;return this.mainPlayerId},getPackets:function(t){return this.frames[t]?this.frames[t]:[]},getPacketsIn:function(t,e){for(var i=[],n=0,s=this.packets.length;s>n;n++){var a=this.packets[n];a.clock>=t&&a.clock<=e&&i.push(a)}return i},getMap:function(){return this.begin.mapName},getVehicle:function(t){return this.begin.vehicles[t]?this.begin.vehicles[t]:null},getVehicles:function(){return this.begin.vehicles},get2DCoords:function(t,e,i){var n=this.data.map.boundingBox;return[(t[0]-n[0])/(n[2]-n[0])*e,(t[2]-n[1])/(n[3]-n[1])*i,t[1]]},getPlayerPackets:function(t){for(var e=[],i=0,n=this.packets.length;n>i;i++){var s=this.packets[i];s.playerId&&s.playerId==t&&e.push(s)}return e},getPacketsByType:function(t,e){for(var i=[],n=0,s=this.packets.length;s>n;n++){var a=this.packets[n];a.type!=t||"undefined"!=typeof e&&a.subType!=e||i.push(a)}return i},getTypes:function(t){t||(t=this.packets);for(var e={},i=0,n=t.length;n>i;i++){var s=t[i];if(e[s.type]){var a=e[s.type].sizes.indexOf(s.length);-1==a&&e[s.type].sizes.push(s.length),e[s.type].count+=1,e[s.type].packets.push(s)}else e[s.type]={count:1,packets:[s],sizes:[s.length]}}return e}},wot.replay.packet=function(){this.construct.apply(this,arguments)},wot.replay.packet.prototype={construct:function(t){this.view=new DataView(t),this.data=t,this.length=t.byteLength,this.type=this.view.getUint32(4,!0),this.length>8&&(this.clock=this.view.getFloat32(8,!0)),this.types[this.type]&&this.types[this.type].apply(this,[this.view])}},wot.replay.packet.reader=function(t){this.data=t,this.view=new DataView(t)},wot.replay.packet.reader.prototype={BASE_PACKET_SIZE:12,position:0,next:function(){var t=this.view.getInt32(this.position,!0),e=t+this.BASE_PACKET_SIZE;if(this.position+e>this.data.byteLength)throw new Error("Packet outside bounds!");var i=new wot.replay.packet(this.data.slice(this.position,this.position+e));return this.previous=this.position,this.position+=e,i},hasNext:function(){return!(this.position>=this.data.byteLength)}},wot.replay.packet.prototype.types={0:function(t){this.playerAltID=t.getUint32(12,!0),this.playerName="";for(var e=Math.min(t.getUint32(19),this.length-23),i=0;e>i;i++)this.playerName+=String.fromCharCode(t.getUint8(23+i,!0))},3:function(t){this.playerId=t.getUint32(12,!0)},5:function(t){this.playerId=t.getUint32(12,!0),this.health=t.getUint16(63,!0)},7:function(t){switch(this.playerId=t.getUint32(12,!0),this.subType=t.getUint32(16,!0),this.subType){case 2:this.turretRotation=t.getUint16(24,!0),this.turretRotation=this.turretRotation/65535*(2*Math.PI)-Math.PI;break;case 3:this.health=t.getUint16(24,!0);break;case 4:this.gunRotation=t.getUint16(24,!0),this.gunRotation=this.gunRotation/65535*(2*Math.PI)-Math.PI}},8:function(t){switch(this.playerId=t.getUint32(12,!0),this.subType=t.getUint32(16,!0),this.subType){case 1:this.health=t.getUint16(24,!0),this.source=t.getUint32(26,!0)}},10:function(t){this.position=[],this.hullRotation=[],this.playerId=t.getUint32(12,!0),this.position[0]=t.getFloat32(24,!0),this.position[1]=t.getFloat32(28,!0),this.position[2]=t.getFloat32(32,!0),this.hullRotation[0]=t.getFloat32(48,!0),this.hullRotation[1]=t.getFloat32(52,!0),this.hullRotation[2]=t.getFloat32(56,!0)},18:function(t){this.gameState=t.getUint32(12,!0)},24:function(t){this.angle=t.getFloat32(12,!0)},25:function(t){this.angle=t.getFloat32(12,!0)},27:function(t){this.angle=t.getFloat32(12,!0)},30:function(t){this.playerId=t.getUint32(12,!0)}};
//# sourceMappingURL=../../dist/wot.min.js.map